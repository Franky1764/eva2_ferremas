<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Carrito de Compras | Ferremas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-5">
    <h1 class="text-center mb-4 text-success">ðŸ›’ Carrito de Compras</h1>

    <div id="productos" class="row g-4">
        <!-- AquÃ­ se cargarÃ¡n los productos -->
    </div>

    <hr class="my-5">

    <h3 class="text-primary">ðŸ§º Carrito</h3>
    <ul id="carrito" class="list-group mb-3">
        <!-- Items del carrito -->
    </ul>

    <div id="toggleDiv" class="form-check form-switch mb-2 d-none">
        <input class="form-check-input" type="checkbox" id="toggleMoneda">
        <label class="form-check-label" for="toggleMoneda">Mostrar total en USD</label>
    </div>


    <h4>Total: <span id="total">0</span> <span id="moneda">CLP</span></h4>
</div>

<script>
    const carrito = [];
    const productosContainer = document.getElementById('productos');
    const carritoLista = document.getElementById('carrito');
    const totalSpan = document.getElementById('total');
    const monedaSpan = document.getElementById('moneda');
    let valorDolar = null;

    // Obtener productos desde la API
    fetch('/productos')
        .then(response => response.json())
        .then(productos => {
            productos.forEach(producto => {
                const card = document.createElement('div');
                card.className = 'col-md-4';

                card.innerHTML = `
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">${producto.nombre}</h5>
                            <p class="card-text">
                                Marca: <strong>${producto.marca}</strong><br>
                                Modelo: ${producto.modelo}<br>
                                Stock disponible: ${producto.stock}<br>
                                Precio: <strong>${producto.precio} CLP</strong>
                            </p>
                            <button class="btn btn-sm btn-success" onclick='agregarAlCarrito(${JSON.stringify(producto)})'>Agregar al carrito</button>
                        </div>
                    </div>
                `;

                productosContainer.appendChild(card);
            });
        });

    fetch("/valor-dolar")
        .then(res => res.json())
        .then(data => {
            if (data.dolar_clp) {
                valorDolar = data.dolar_clp;
                document.getElementById('toggleDiv').classList.remove("d-none");
            }
    });


    function agregarAlCarrito(producto) {
        const existente = carrito.find(p => p.id === producto.id);

        if (existente) {
            existente.cantidad += 1;
        } else {
            carrito.push({ ...producto, cantidad: 1 });
        }

        actualizarCarrito();
    }

    function actualizarCarrito() {
        carritoLista.innerHTML = '';
        let total = 0;

        carrito.forEach(item => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `
                ${item.nombre} x${item.cantidad}
                <span>${(item.precio * item.cantidad).toLocaleString('es-CL')} CLP</span>
            `;
            carritoLista.appendChild(li);
            total += item.precio * item.cantidad;
        });

        mostrarTotal(total);
    }

function mostrarTotal(totalCLP) {
    const mostrarEnUSD = document.getElementById('toggleMoneda').checked;

    if (mostrarEnUSD) {
        if (valorDolar) {
            const totalUSD = totalCLP / valorDolar;
            totalSpan.innerText = totalUSD.toFixed(2);
            monedaSpan.innerText = 'USD';
        } else {
            totalSpan.innerText = totalCLP.toLocaleString('es-CL');
            monedaSpan.innerText = 'CLP';
        }
    } else {
        totalSpan.innerText = totalCLP.toLocaleString('es-CL');
        monedaSpan.innerText = 'CLP';
    }
}
   document.getElementById('toggleMoneda').addEventListener('change', actualizarCarrito);

</script>
</body>
</html>
